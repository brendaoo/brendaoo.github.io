<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>AWS IAM小结</title>
    <url>/2022/05/09/AWS_IAM%E5%B0%8F%E7%BB%93/</url>
    <content><![CDATA[<h1 id="AWS-IAM小结"><a href="#AWS-IAM小结" class="headerlink" title="AWS IAM小结"></a>AWS IAM小结</h1><h2 id="PART1-问题及总结"><a href="#PART1-问题及总结" class="headerlink" title="PART1 问题及总结"></a>PART1 问题及总结</h2><h3 id="什么是AWS-IAM？"><a href="#什么是AWS-IAM？" class="headerlink" title="什么是AWS IAM？"></a>什么是AWS IAM？</h3><p>AWS Identity and Access Management (IAM) 是一种 Web 服务，可以帮助您安全地控制对 AWS 资源的访问。<strong>可以使用 IAM 来控制谁通过了身份验证（准许登录）并获得授权（拥有权限）来使用资源。</strong></p>
<h3 id="跟账户用户"><a href="#跟账户用户" class="headerlink" title="跟账户用户"></a>跟账户用户</h3><p>当您首次创建AWS 账户时，最初使用的是一个对账户中所有AWS服务和资源有完全访问权限的单点登录身份。此身份称为<strong>AWS 账户根用户</strong>，使用您创建账户时所用的电子邮件地址和密码登录，即可获得该身份。强烈建议您不使用根用户执行日常任务，即使是管理任务。相反，请遵循<a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html#create-iam-users">仅使用根用户创建您的第一个 IAM 用户的最佳实践</a>。然后请妥善保存根用户凭证，仅用它们执行少数账户和服务管理任务。</p>
<h3 id="IAM用户的密钥设计"><a href="#IAM用户的密钥设计" class="headerlink" title="IAM用户的密钥设计"></a>IAM用户的密钥设计</h3><ul>
<li>所需账户：一个账户</li>
<li>涉及服务：IAM、S3</li>
<li>描述：只给用户分配STSAssumeRole的权限，没有访问S3的权限，用户需要通过AssumeRole返回的临时凭证去访问S3.</li>
</ul>
<h3 id="多账户—中央账户管理"><a href="#多账户—中央账户管理" class="headerlink" title="多账户—中央账户管理"></a>多账户—中央账户管理</h3><p>中央账户与成员账户使用AWS Organizations服务</p>
<ul>
<li><p>加入组织：中央账户邀请成员账户加入Organizations</p>
</li>
<li><p>服务控制策略：中央账户可以对成员账户实行策略上的限制，比如说，限制成员账户访问自己账户的S3存储桶。策略生效之后，成员账户的根账户也无法访问自己账户下的S3存储桶。</p>
</li>
</ul>
<h3 id="多账户—跨账户IAM角色访问"><a href="#多账户—跨账户IAM角色访问" class="headerlink" title="多账户—跨账户IAM角色访问"></a>多账户—跨账户IAM角色访问</h3><ul>
<li><p>所需账户：至少2个账户</p>
</li>
<li><p>涉及服务：S3存储桶、IAM</p>
</li>
<li><p>描述：两个账户，eg Account A和Account B，A赋予B当中的用户访问A账户S3存储桶的权限</p>
</li>
</ul>
<p>2个账户场景，2个账户不需要有什么关联，即2个账户不需要在同一个组织中。</p>
<h3 id="多账户—集中式日志存储"><a href="#多账户—集中式日志存储" class="headerlink" title="多账户—集中式日志存储"></a>多账户—集中式日志存储</h3><ul>
<li><p>账户要求：至少需要2个账户，eg Account A 和 Account B，需要选定一个账户作为中央账户</p>
</li>
<li><p>涉及服务：S3存储桶、IAM、AWS CloudWatch、AWS Config等</p>
</li>
<li><p>描述：中央账户的S3存储桶存储其他账户的CloudWatch以及AWS Config等服务的日志</p>
</li>
</ul>
<h2 id="PART2-参考文献"><a href="#PART2-参考文献" class="headerlink" title="PART2 参考文献"></a>PART2 参考文献</h2><ul>
<li><a href="https://docs.aws.amazon.com/zh_cn/IAM/latest/UserGuide/introduction.html">什么是AWS IAM</a></li>
</ul>
]]></content>
      <tags>
        <tag>AWS</tag>
        <tag>IAM</tag>
      </tags>
  </entry>
  <entry>
    <title>AWS Organizations账户管理服务&amp;SCP</title>
    <url>/2022/05/09/AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1&amp;SCP/</url>
    <content><![CDATA[<h1 id="AWS-Organizations账户管理服务-amp-SCP"><a href="#AWS-Organizations账户管理服务-amp-SCP" class="headerlink" title="AWS Organizations账户管理服务&amp;SCP"></a>AWS Organizations账户管理服务&amp;SCP</h1><h2 id="Part1-介绍AWS-Organizations"><a href="#Part1-介绍AWS-Organizations" class="headerlink" title="Part1 介绍AWS Organizations"></a>Part1 介绍AWS Organizations</h2><p>AWS Organizations 是一项账户管理服务，使您能够将多个AWS 账户整合到您创建并集中管理的组织中。AWS Organizations 包含账户管理和整合账单功能，可利用这些功能更好地满足企业的预算、安全性和合规性需求。作为组织的管理员，您可以在组织中创建账户并邀请现有账户加入组织。</p>
<p><strong>AWS Organizations功能</strong></p>
<ul>
<li>集中管理您的所有AWS账户</li>
<li>所有成员账户的整合账单</li>
<li>对账户进行分层分组以满足预算、安全性或合规性需求</li>
<li>集中控制每个账户可访问的AWS服务和API操作的策略</li>
<li>帮助在组织账户中跨资源标准化标签的策略</li>
<li>控制AWS AI和机器学习服务可以手机和存储数据的策略</li>
<li>为组织账户中的资源配置自动备份的策略</li>
<li>针对AWS IAM的集成和支持</li>
<li>与其他AWS服务集成</li>
<li>全局访问</li>
<li>具备最终一致性的数据复制</li>
<li>免费使用</li>
</ul>
<h2 id="Part2-实验场景"><a href="#Part2-实验场景" class="headerlink" title="Part2 实验场景"></a>Part2 实验场景</h2><p>前提条件：需要2个账户，称作Account A和Account B。</p>
<p>描述：在Account A中创建组织，并邀请Account B加入组织。在Account A中设置策略来防止Account B访问S3，在Account B上进行测试。</p>
<p>说明：本实验demo的Account A的ID尾号为5283，Account B的ID尾号为8124</p>
<h2 id="Part3-实验步骤"><a href="#Part3-实验步骤" class="headerlink" title="Part3 实验步骤"></a>Part3 实验步骤</h2><h3 id="3-1-实验账户说明"><a href="#3-1-实验账户说明" class="headerlink" title="3.1 实验账户说明"></a>3.1 实验账户说明</h3><p>本实验demo的Account A的ID尾号为5283，Account B的ID尾号为8124</p>
<p>实验会在Account A账户中创建组织，即Account A是主账户，Account B是成员账户。</p>
<h3 id="3-2-创建组织"><a href="#3-2-创建组织" class="headerlink" title="3.2 创建组织"></a>3.2 创建组织</h3><p>在Account A账户中创建组织。在Organization主页，点击“创建组织”。</p>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412004932107.png" alt="image-20220412004932107"></p>
<p>点击之后直接就能创建组织，创建组织需要邮箱验证。</p>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412005002268.png" alt="image-20220412005002268"></p>
<h3 id="3-3-邀请账户"><a href="#3-3-邀请账户" class="headerlink" title="3.3 邀请账户"></a>3.3 邀请账户</h3><p>输入账户ID和要创建的键值，点击发送邀请。</p>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412011458396.png" alt="image-20220412011458396"></p>
<p>在Account B中可以看到邀请</p>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412011633785.png" alt="image-20220412011633785"></p>
<p>点开邀请链接之后，接受邀请</p>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412011714385.png" alt="image-20220412011714385"></p>
<p>在Account A上查看组织的账户，一个主账户，一个成员账户</p>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412011914453.png" alt="image-20220412011914453"></p>
<h3 id="3-4-创建S3策略"><a href="#3-4-创建S3策略" class="headerlink" title="3.4 创建S3策略"></a>3.4 创建S3策略</h3><p>进入策略页面，点击“服务控制策略”</p>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412102406807.png" alt="image-20220412102406807"></p>
<p>启用服务控制策略</p>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412102431828.png" alt="image-20220412102431828"></p>
<p>加载完成之后，如下所示</p>
<p>新创建一个策略，来阻止对S3的访问，点击创建策略</p>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412102504986.png" alt="image-20220412102504986"></p>
<p>策略设置</p>
<ul>
<li>名称：denyS3</li>
<li>选择服务：S3，动作：All Actions</li>
</ul>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412103202634.png" alt="image-20220412103202634"></p>
<p>添加资源，添加完成之后点击创建策略</p>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412132453499.png" alt="image-20220412132453499"></p>
<h3 id="3-5-前-Account-B访问S3测试"><a href="#3-5-前-Account-B访问S3测试" class="headerlink" title="3.5 [前]Account B访问S3测试"></a>3.5 [前]Account B访问S3测试</h3><p>目前没有给Account B账户做任何限制，Account B可以正常访问S3存储桶</p>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412133347888.png" alt="image-20220412133347888"></p>
<h3 id="3-6-将策略应用到Account-B"><a href="#3-6-将策略应用到Account-B" class="headerlink" title="3.6 将策略应用到Account B"></a>3.6 将策略应用到Account B</h3><p>在Account A账户的Organizations中，将denyS3策略附加到Account B</p>
<p>选中denyS3策略，点击操作。点击附加策略</p>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412133545337.png" alt="image-20220412133545337"></p>
<p>选中要附加的这个账户，点击附加策略</p>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412133640477.png" alt="image-20220412133640477"></p>
<p>Okay，策略附加成功</p>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412133717996.png" alt="image-20220412133717996"></p>
<h3 id="3-7-后-Account-B访问S3测试"><a href="#3-7-后-Account-B访问S3测试" class="headerlink" title="3.7 [后]Account B访问S3测试"></a>3.7 [后]Account B访问S3测试</h3><p>Account A为Account B添加了限制S3所有权限的策略，现在Account B账户上访问S3进行测试。</p>
<p><img src="/images/images-AWS_Organizations%E8%B4%A6%E6%88%B7%E7%AE%A1%E7%90%86%E6%9C%8D%E5%8A%A1%5Cimage-20220412133938873.png" alt="image-20220412133938873"></p>
<p>Account B再次访问S3时出现提示：无权列出存储桶。所以可以看出策略附加成功，在Account B上已经生效。</p>
<p>总结：本实验是一个简单的AWS Organizations创建以及测试，主要测试的服务控制策略SCP。Organizations还有很多别的功能。</p>
<h2 id="Part4-参考文献"><a href="#Part4-参考文献" class="headerlink" title="Part4 参考文献"></a>Part4 参考文献</h2><ul>
<li><a href="https://docs.aws.amazon.com/zh_cn/zh_cn/organizations/latest/userguide/orgs_introduction.html">什么是AWS Organizations</a></li>
</ul>
]]></content>
      <tags>
        <tag>AWS</tag>
        <tag>IAM</tag>
        <tag>Organizations</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2022/05/09/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>配置CloudTrial和Config日志跨AWS账户日志存储</title>
    <url>/2022/05/15/%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8/</url>
    <content><![CDATA[<h1 id="配置CloudTrial和Config日志跨AWS账户日志存储"><a href="#配置CloudTrial和Config日志跨AWS账户日志存储" class="headerlink" title="配置CloudTrial和Config日志跨AWS账户日志存储"></a>配置CloudTrial和Config日志跨AWS账户日志存储</h1><h2 id="Part1-集中式日志存储架构"><a href="#Part1-集中式日志存储架构" class="headerlink" title="Part1 集中式日志存储架构"></a>Part1 集中式日志存储架构</h2><p>集中式日志存储架构：将所有账户的所需日志都集中存储在一个中心区域，在这个中心区域中对日志进行定期监控和分析。架构图如下所示：</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220415115536224.png" alt="image-20220415115536224"></p>
<p>**集中日志管理注意事项： ** </p>
<ul>
<li>尽早定义日志保留的要求以及日志生命周期策略。选择合适的生命周期策略以节省成本。</li>
<li>日志生命周期策略自动化。</li>
<li>自动安装和配置日志传输代理程序。</li>
<li>支持混合云架构。企业会想要将数据放到自己的私有云，解决方案需要适配混合云架构。</li>
</ul>
<p><strong>AWS提供的相关服务</strong></p>
<p>AWS提供很多服务帮助构建集中式日志解决方案：AWS ElasticSearch Service、AWS CloudWatch Logs、Kinesis Firehose、AWS S3等。</p>
<p>不同的AWS服务构建集中式日志解决方案的配置方式各不相同。</p>
<h2 id="Part2-实验说明"><a href="#Part2-实验说明" class="headerlink" title="Part2 实验说明"></a>Part2 实验说明</h2><p>本次的实验demo需要<font color="red">2个账户</font>，一个作为中央账户（Account A），提供S3存储桶存储日志文件；另一个账户（Account B）的CloudTrial和Config服务的日志存到中央账户的存储桶中。</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220415122335696.png" alt="image-20220415122335696"></p>
<h2 id="Part3-实验步骤"><a href="#Part3-实验步骤" class="headerlink" title="Part3 实验步骤"></a>Part3 实验步骤</h2><h3 id="3-1-A-创建存储桶"><a href="#3-1-A-创建存储桶" class="headerlink" title="3.1 [A]创建存储桶"></a>3.1 [A]创建存储桶</h3><p>在Account A账户中，创建2个S3存储桶。</p>
<p>进入S3存储桶页面之后，点击创建存储桶。写好存储桶名称，点击创建存储桶。存储桶不需要做其他配置。</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220415123330910.png" alt="image-20220415123330910"></p>
<p>创建好2个S3存储桶</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220415123430223.png" alt="image-20220415123430223"></p>
<h3 id="3-2-A-修改存储桶策略"><a href="#3-2-A-修改存储桶策略" class="headerlink" title="3.2 [A]修改存储桶策略"></a>3.2 [A]修改存储桶策略</h3><p><strong>CloudTrail</strong></p>
<p>在存储桶列表页面，点击存储桶名称，进入存储桶的权限页面，在存储桶策略条目点击编辑。</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220417231056049.png" alt="image-20220417231056049"></p>
<p>写入存储桶策略，策略的Resource修改为当前存储桶的arn</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220418105215384.png" alt="image-20220418105215384"></p>
<p>策略代码，策略的内容是允许CloudTrail的日志存储到存储桶</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AWSCloudTrailAclCheck20150319&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;Service&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cloudtrail.amazonaws.com&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3:GetBucketAcl&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:s3:::s3bucket-center-cloudtrail&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AWSCloudTrailWrite20150319&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="attr">&quot;Service&quot;</span><span class="punctuation">:</span> <span class="string">&quot;cloudtrail.amazonaws.com&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3:PutObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:s3:::s3bucket-center-cloudtrail/AWSLogs/580919038124/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;StringEquals&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;s3:x-amz-acl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bucket-owner-full-control&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><font color="red">策略允许 CloudTrail 从支持的区域将日志文件写入存储桶。使用您配置的相应值替换 <code>myBucketName</code>、<code>[optionalPrefix]/</code>、<code>myAccountID</code>。<code>myAccountID</code>为创建CloudTrail账户的Account ID。</font></p>
<ul>
<li>第9行的配置模板</li>
</ul>
<p>“Resource”: “arn:aws:s3:::<code>myBucketName</code>“</p>
<ul>
<li>第16行的配置模板</li>
</ul>
<p>“Resource”: “arn:aws:s3:::<code>myBucketName</code>&#x2F;<code>[optionalPrefix]/</code>AWSLogs&#x2F;<code>myAccountID</code>&#x2F;*”,</p>
<p><strong>Config</strong></p>
<p>存储桶权限配置的流程桶CloudTrail步骤一样，存储桶内容如下</p>
<p>注意：需要将11行和20行中Resource的ARN改成对应存储桶的ARN</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;Version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2012-10-17&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;Statement&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AWSCloudTrailAclCheck20150319&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;Service&quot;</span><span class="punctuation">:</span> <span class="string">&quot;config.amazonaws.com&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3:GetBucketAcl&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:s3:::s3bucket-center-config&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Sid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;AWSCloudTrailWrite20150319&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Effect&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Allow&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Principal&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;Service&quot;</span><span class="punctuation">:</span> <span class="string">&quot;config.amazonaws.com&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Action&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s3:PutObject&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Resource&quot;</span><span class="punctuation">:</span> <span class="string">&quot;arn:aws:s3:::s3bucket-center-config/*&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Condition&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;StringEquals&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;s3:x-amz-acl&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bucket-owner-full-control&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>





<h3 id="3-3-B-配置CloudTrail"><a href="#3-3-B-配置CloudTrail" class="headerlink" title="3.3 [B]配置CloudTrail"></a>3.3 [B]配置CloudTrail</h3><p>在Account B中创建CloudTrail跟踪。点击控制面板进入，而不是直接点击创建跟踪（该方式通过向导创建，不能修改日志存储的S3桶）。</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220418001946116.png" alt="image-20220418001946116"></p>
<p>在控制面板页面点击创建跟踪</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220418002035027.png" alt="image-20220418002035027"></p>
<p>跟踪记录配置</p>
<ul>
<li>跟踪名称：Event-AccountB</li>
<li>存储位置：使用现有的S3存储桶，填入3.1中创建的S3存储桶</li>
<li>不启用KMS加密</li>
</ul>
<p>配置填完之后，点击下一个</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220420192711571.png" alt="image-20220420192711571"></p>
<p>点击下一个，之后点击创建跟踪</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220418003426667.png" alt="image-20220418003426667"></p>
<p>点击创建跟踪</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220420192903553.png" alt="image-20220420192903553"></p>
<p>CloudTrail的跟踪创建成功</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220420192942709.png" alt="image-20220420192942709"></p>
<h3 id="3-4-A-查看CloudTrail存储桶"><a href="#3-4-A-查看CloudTrail存储桶" class="headerlink" title="3.4 [A]查看CloudTrail存储桶"></a>3.4 [A]查看CloudTrail存储桶</h3><p>在Accoun A账户下，进入存储桶可以看到有AWSLogs文件夹</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220420193128504.png" alt="image-20220420193128504"></p>
<p>进入AWSLogs之下是一个以Account B ID命名的目录</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220420193559417.png" alt="image-20220420193559417"></p>
<p>进入Account B ID之下的目录中，有2个带有CloudTrail的文件夹</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220420193657809.png" alt="image-20220420193657809"></p>
<p>okay，Account B的CloudTail日志信息可以存储到Account B的S3存储桶当中。</p>
<h3 id="3-5-B-创建Config"><a href="#3-5-B-创建Config" class="headerlink" title="3.5 [B]创建Config"></a>3.5 [B]创建Config</h3><p>进入Account B账户</p>
<p>进入AWS Config页面，点击设置AWS Config</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220420200636186.png" alt="image-20220420200636186"></p>
<p>AWS Config设置</p>
<ul>
<li><p>一般设置内容保持默认</p>
</li>
<li><p>交付方式</p>
<ul>
<li>S3存储桶选择：从另一个账户选择存储桶</li>
<li>填入存储桶名称：s3bucket-center-config</li>
</ul>
</li>
</ul>
<p>点击下一步</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220420200727953.png" alt="image-20220420200727953"></p>
<p>规则这一页全选，点击下一步</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220420201203114.png" alt="image-20220420201203114"></p>
<p>审核无误之后点击确认</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220420201334885.png" alt="image-20220420201334885"></p>
<h3 id="3-6-A-查看Config存储桶"><a href="#3-6-A-查看Config存储桶" class="headerlink" title="3.6 [A]查看Config存储桶"></a>3.6 [A]查看Config存储桶</h3><p>进入Account A账户，进入s3bucket-center-config S3存储桶</p>
<p>看到存储桶中有一个AWSLogs目录，用来记录Config的日志信息</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220420201943933.png" alt="image-20220420201943933"></p>
<p>一直进入到AWSLogs目录下的最底层目录之下，看到一个ConfigWritabilityCheckFile文件，checkfile文件生成表明config的跨账户日志存储配置成功。</p>
<p><img src="/images/images-%E9%85%8D%E7%BD%AECloudTrial%E5%92%8CConfig%E6%97%A5%E5%BF%97%E8%B7%A8AWS%E8%B4%A6%E6%88%B7%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%5Cimage-20220420202153455.png" alt="image-20220420202153455"></p>
<p>Okay，Config的日志跨账户完成。</p>
<h2 id="Part4-注意点"><a href="#Part4-注意点" class="headerlink" title="Part4 注意点"></a>Part4 注意点</h2><ol>
<li>Account A S3存储桶的权限配置，将代码copy到自己的存储桶中时一定要修改ARN参数</li>
<li>3.3步骤配置Account B CloudTrail时，不能开启KMS加密。因为当前Account A中S3的策略还不支持加密，还没研究出支持KMS加密的策略。</li>
</ol>
<h2 id="Part5-参考文献"><a href="#Part5-参考文献" class="headerlink" title="Part5 参考文献"></a>Part5 参考文献</h2><ul>
<li><a href="https://docs.aws.amazon.com/zh_cn/awscloudtrail/latest/userguide/create-s3-bucket-policy-for-cloudtrail.html">针对CloudTrail的Amazon S3存储桶策略</a></li>
</ul>
]]></content>
      <tags>
        <tag>AWS</tag>
        <tag>IAM</tag>
      </tags>
  </entry>
</search>
